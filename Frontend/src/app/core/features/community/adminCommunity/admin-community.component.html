<div class="container">

  <div class="level">
    <div class="level-left">
      <h2 class="title">Comunidades</h2>
    </div>
    <div class="level-right">
      <button class="button" (click)="openAddModal()">
        <span class="icon mr-1">
          <i class="fa-solid fa-plus"></i>
        </span>
        Agregar Comunidad
      </button>
    </div>
  </div>

</div>
@if (isLoading) {
  <div class="container">
    <div class="skeleton-lines">
      <div></div>
      <div></div>
      <div></div>
      <div></div>
    </div>
  </div>
} @else {
  <div class="container mt-4">
    <div class="box">
      <div class="table-container">
        <table class="table is-fullwidth">
          <thead>
            <tr>
              <th>#</th>
              <th>Nombre</th>
              <th>Dirección</th>
              <th>Administrado por</th>
              <th>Acciones</th>
            </tr>
          </thead>

          <tbody>
            @for (community of communities; track community.id; let idx = $index , e =
            $even) {
            <tr>
              <td>{{ idx + 1 }}</td>
              <td>{{ community.name }}</td>
              <td>
                {{
                  community.address +
                    ", " +
                    community.municipality +
                    ", " +
                    community.city
                }}
              </td>
              <td>{{ community.adminName }}</td>
              <td>
                <button class="button is-warning" (click)="edit(community.id)">
                  <i class="mr-2 fa-solid fa-pen-to-square"></i>Editar
                </button>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="modal" [ngClass]="{ 'is-active': ActivateModal }">
    <div class="modal-background" (click)="closemodal()"></div>
    <div class="modal-card">
      <header class="modal-card-head is-shadowless">
        <p class="modal-card-title">Editar comunidad</p>
        <button class="delete" aria-label="close" (click)="closemodal()"></button>
      </header>
      <section class="modal-card-body">
        <form  [formGroup]="communityForm" [hidden]="notificacion && success">
          <div class="columns">
            <div class="column field">
              <label class="label">Nombre comunidad</label>
              <div class="control">
                <input
                  class="input"
                  type="text"
                  formControlName="name"
                  placeholder="Nombre de comunidad"
                  [ngClass]="{ 'is-skeleton': loadingLocation }"
                />
              </div>
            </div>
          </div>
          <div class="columns">
            <div class="column field">
              <label class="label">Rut comunidad</label>
              <div class="control">
                <input
                  class="input"
                  type="text"
                  formControlName="rut"
                  placeholder="Rut de comunidad"
                  [ngClass]="{ 'is-skeleton': loadingLocation }"
                />
              </div>
            </div>
          </div>
            <div class="columns">
            <div class="column field">
              <label class="label">Administrador</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select
                    formControlName="adminId"
                    [ngClass]="{ 'is-skeleton': loadingLocation }"
                  >
                    <option>Seleccione un Administrador</option>
                    @for (admin of adminUsers; track $index) {
                    <option value="{{ admin.id }}">{{ admin.fullName }}</option>
                    }
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="columns">
            <div class="column is-full">
              <label class="label" for="address">Dirección</label>
              <div class="control">
                <input
                  class="input"
                  id="address"
                  type="text"
                  formControlName="address"
                  placeholder="Ingrese Dirección #123"
                  [ngClass]="{ 'is-skeleton': loadingLocation }"
                />
              </div>
            </div>
          </div>

          <div class="columns">
            <div class="column is-full">
              <div class="field">
                <label class="label" >Región</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select
                      (change)="onChangeRegion($event)"
                      formControlName="regionId"
                      [ngClass]="{ 'is-skeleton': loadingLocation }"
                    >
                      <option value="0">Seleccione Región</option>
                      @for (region of regions; track $index) {
                        <option value="{{ region.id }}">{{ region.name }}</option>
                      }
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="columns">
            <div class="column is-full">
              <div class="field">
                <label class="label">Ciudad</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select
                      (change)="onChangeCity($event)"
                      formControlName="cityId"
                      [ngClass]="{ 'is-skeleton': loadingLocation }"
                    >
                      <option value="0">Seleccione Ciudad</option>
                      @for (city of cities; track $index) {
                        <option value="{{ city.id }}">{{ city.name }}</option>
                      }
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="columns">
            <div class="column is-full">
              <div class="field">
                <label class="label" >Municipalidad</label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <select
                      formControlName="municipalityId"
                      [ngClass]="{ 'is-skeleton': loadingLocation }"
                    >
                      <option value="0">Seleccione Comuna</option>
                      @for (municipality of municipalities; track $index) {
                        <option value="{{ municipality.id }}">
                          {{ municipality.name }}
                        </option>
                      }
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </form>

            @if (notificacion) { @if(success){
              <div class="notification is-success">
                <button class="delete" (click)="closeNotification()"></button>
                Comunidad actualizada.
              </div>
            } @else {
              <div class="notification is-danger">
                <button class="delete" (click)="closeNotification()"></button>
                No fue posible actualizar la comunidad.
              </div>
            } }

      </section>

      <footer class="modal-card-foot">
        <div class="buttons">
          <button
            class="button is-danger"
            [ngClass]="{ 'is-loading': updating }"
            [disabled]="!communityForm.valid"
            (click)="onClickSave()"
          >
            Guardar cambios
          </button>
          <button class="button" (click)="closemodal()" [disabled]="updating">
            Salir
          </button>
        </div>
      </footer>
    </div>
  </div>
}

@if(isModalOpen){
  <app-add-community (close)="onClickCloseAdd()">
  </app-add-community>
}
